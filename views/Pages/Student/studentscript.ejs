<script>
    $(document).ready(function () {
        $(document).on('click', '#BtnAddStudent', function () {
            $('#addStudent').modal('show');
        });
    })
    $(document).ready(function () {
        $(document).on('click', '#BtnAddSubject', function () {
            $('#addSubject').modal('show');
        });
    })
    $(document).ready(function () {
        $(document).on('click', '#BtnView', function () {
            $('#viewModal').modal('show');
        });
    })
    $(document).ready(function () {
        $(document).on('click', '#BtnEdit', function () {
            $('#editModal').modal('show');
        });
    })
    $(document).ready(function () {
        $(document).on('click', '#BtnEdit2', function () {
            $('#editModal2').modal('show');
        });
    })
    $(document).ready(function () {
        $(document).on('click', '#BtnDelete2', function () {
            $('#editModal').modal('show');
        });
    })
    $(document).ready(function () {
        $(document).on('click', '#BtnDelete', function () {
            $('#deleteStudent').modal('show');
        });
    })


    //POST-STUDENT
    $(document).on('click', '#confirmBtn', function () {
        let first_name = $('#first_name').val();
        let middle_name = $('#middle_name').val();
        let last_name = $('#last_name').val();
        let date_of_birth = $('#date_of_birth').val();
        let contact_no = $('#contact_no').val();
        let email = $('#email').val();
        let address = $('#address').val();

        $.ajax({
            url: '/student/add-student',
            method: 'POST',
            data: {
                first_name: first_name,
                middle_name: middle_name,
                last_name: last_name,
                date_of_birth: date_of_birth,
                contact_no: contact_no,
                email: email,
                address: address,
            },
            success: function (data) {
                console.log(data);
                $('#addStudent').modal('hide');
            },
            error: function (error) {
                console.log(error);
            }
        });
    });

    $(document).on('click', '#BtnDelete', function () {
        let studentId = $(this).data('id');  // Get the student ID from the button's data attribute
        console.log('Student ID to delete:', studentId);  // Log for debugging

        if (studentId) {
            // Set the student ID in the modal's delete button
            $('#deleteStudent').find('#BtnDeleteStudent').data('id', studentId);

            // Show the delete confirmation modal
            $('#deleteStudent').modal('show');
        } else {
            console.log('Student ID is undefined');
        }
    });

    $(document).on('click', '#BtnDeleteStudent', function () {
        let studentId = $(this).data('id');  // Get the student ID from the modal's delete button
        console.log('Student ID to delete:', studentId);  // Log for debugging

        if (!studentId) {
            console.log('Student ID is undefined');
            return;  // Exit if ID is not set
        }

        // Confirm before deleting
        if (confirm("Are you sure you want to delete this student?")) {
            $.ajax({
                url: '/student/delete-student/' + studentId,  // Endpoint to delete student
                method: 'DELETE',
                success: function (response) {
                    console.log('Delete successful:', response);

                    // Show a success message to the user
                    alert('Student deleted successfully.');

                    // Optionally remove the student row from the table
                    $(`#student-row-${studentId}`).remove();

                    // Optionally reload the page or fetch updated data
                    // location.reload();
                },
                error: function (error) {
                    console.log('Error deleting student:', error);

                    // Show an error message to the user
                    alert('Failed to delete student. Please try again.');
                }
            });
        }
    });




    //GET-STUDENT
    $(document).ready(function () {
        // Fetch students from the database
        $.ajax({
            url: '/student/get-student',  // The endpoint to get the student data
            method: 'GET',
            success: function (data) {
                console.log(data);  // Log the full response to inspect it

                // Check if students is an array and handle the response
                if (Array.isArray(data.students)) {
                    // Empty the table body before appending new rows
                    $('#studentsTable tbody').empty();

                    // Loop through the students array and add rows to the table
                    data.students.forEach(student => {
                        $('#studentsTable tbody').append(`
                        <tr>
                            <th scope="row">${student.ms_student_id}</th>
                            <td>${student.ms_first_name}</td>
                            <td>${student.ms_middle_name}</td>
                            <td>${student.ms_last_name}</td>
                            <td>${student.ms_date_of_birth}</td>
                            <td>${student.ms_contact_no}</td>
                            <td>${student.ms_email}</td>
                            <td>${student.ms_address}</td>
                            <td>${student.ms_status}</td>
                            <td>${student.ms_created_by}</td>
                            <td>${student.ms_created_date}</td>
                            <td>
                                <button class="btn btn-success" id="BtnView" data-id="${student.ms_id}">View</button>
                            </td>
                            <td class="d-flex" style="gap: 10px;">
                                <button class="btn btn-primary" id="BtnEdit" data-id="${student.ms_id}">Edit</button>
                                <button class="btn btn-danger" id="BtnDelete" data-id="${student.ms_id}">Delete</button>
                            </td>
                        </tr>
                    `);
                    });
                } else {
                    console.log('Error: "students" is not an array or missing');
                }
            },
            error: function (error) {
                console.log('Error fetching students:', error);
            }
        });
    });

    //PUT-STUDENT (Display student data on edit modal and send ID to update)
    $(document).on('click', '#BtnEdit', function () {
        let studentId = $(this).data('id');
        console.log('Student ID:', studentId);  // Log to ensure the student ID is being passed correctly

        if (studentId) {
            $.ajax({
                url: '/student/get-student/' + studentId,  // Fetch the student data using the ID
                method: 'GET',
                success: function (data) {
                    console.log(data);  // Log the response to check data

                    // Check if student data exists in the response
                    if (data.student) {
                        // Populate the modal fields with student data
                        $('#student_id_edit').val(data.student.ms_student_id);
                        $('#first_name_edit').val(data.student.ms_first_name);
                        $('#middle_name_edit').val(data.student.ms_middle_name);
                        $('#last_name_edit').val(data.student.ms_last_name);
                        $('#date_of_birth_edit').val(data.student.ms_date_of_birth);
                        $('#contact_no_edit').val(data.student.ms_contact_no);
                        $('#email_edit').val(data.student.ms_email);
                        $('#status_edit').val(data.student.ms_status);
                        $('#address_edit').val(data.student.ms_address);
                        $('#created_by_edit').val(data.student.ms_created_by);
                        $('#created_date_edit').val(data.student.ms_created_date);

                        // Store ms_id in a data attribute on the modal
                        $('#editModal').data('ms_id', studentId);

                        // Optional: Set image if exists, otherwise set a placeholder image
                        if (data.student.ms_image) {
                            $('img.img-thumbnail').attr('src', data.student.ms_image);
                        } else {
                            $('img.img-thumbnail').attr('src', 'https://i.ibb.co/PxNQTt0/image-2025-01-22-133732301.png');  // Placeholder image
                        }

                        // Show the modal with the populated student data
                        $('#editModal').modal('show');
                    }
                },
                error: function (error) {
                    console.log('Error fetching student data:', error);
                }
            });
        } else {
            console.log('Student ID is undefined');
        }
    });


    //Update student data
    $(document).on('click', '#saveEdit', function () {
        // Get ms_id from the modal's data attribute
        let ms_id = $('#editModal').data('ms_id');

        if (!ms_id) {
            alert('Unable to determine the student to update. Please try again.');
            return;
        }

        // Gather updated data from the modal fields
        let updatedStudentData = {
            ms_id: ms_id,
            ms_student_id: $('#student_id_edit').val(),
            ms_first_name: $('#first_name_edit').val(),
            ms_middle_name: $('#middle_name_edit').val(),
            ms_last_name: $('#last_name_edit').val(),
            ms_date_of_birth: $('#date_of_birth_edit').val(),
            ms_contact_no: $('#contact_no_edit').val(),
            ms_email: $('#email_edit').val(),
            ms_status: $('#status_edit').val(),
            ms_address: $('#address_edit').val(),
            ms_created_by: $('#created_by_edit').val(),
            ms_created_date: $('#created_date_edit').val()
        };

        console.log('Updated Student Data:', updatedStudentData); // Log for debugging

        // Send the updated data via an AJAX request
        $.ajax({
            url: '/student/update-student/' + ms_id, // Use ms_id for the update endpoint
            method: 'PUT',  // Change to 'PUT' if your API requires it
            contentType: 'application/json',
            data: JSON.stringify(updatedStudentData), // Convert the data to JSON string
            success: function (response) {
                console.log('Update successful:', response);

                // Show a success message to the user
                alert('Student details updated successfully.');

                // Optionally refresh the data or close the modal
                $('#editModal').modal('hide');

                // Optionally reload the page or table data
                // location.reload();
            },
            error: function (error) {
                console.log('Error updating student data:', error);

                // Show an error message to the user
                alert('Failed to update student details. Please try again.');
            }
        });
    });

</script>